---
title: C语言中返回自己的函数
tags:
  - C
  - 奇技淫巧
categories:
  - 计算机
date: 2016-12-09 23:47:31
---

偶然看到这样的一道题：

> 怎样在C语言中写出一个函数，它返回指向自己的指针呢？也就是说，设法使下面的程序通过编译且正常运行：
>
> ```C
typedef （在此写出FuncPtr的原型）;
（在此补全代码）
int main() {
    FuncPtr f1 = f();  // 调用f
    FuncPtr f2 = f1(); // 又调用f
    FuncPtr f3 = f2(); // 又调用f
    // 无论再写多少行也不会有问题
    return 0;
}
```

如果禁止使用隐式类型转换，那么显然是不可能写出f准确的原型的。Stack Overflow上面类似的问题下方回答也是清一色的“做不到”。但是我还是找到了一个解，它能满足题目要求。

<!--more-->这个解很简单，它依赖于C会隐式地将`void*`类型转换为任何指针类型的特性：

```C
typedef void *(*FuncPtr)();

void *f() { return f; }

int main() {
    FuncPtr f1 = f();
    FuncPtr f2 = f1();
    FuncPtr f3 = f2();
    return 0;
}
```

顺便一提，这道题目本身还用到了C的一个隐式类型转换：调用指向函数的指针等价于调用其所指向的对象，因此不用写`(*f1)()`而只需写`f1()`。我给出的这段程序为了简洁，利用了另一个C的隐式类型转换：将函数赋值给指针时会自动对其取地址，因此不用写`return &f`而只需写`return f`。
